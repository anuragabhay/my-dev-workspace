# Priority-ordered decision rules for the Orchestrator.
# Evaluated in order; first matching rule determines action.
# Narrative: agent-automation/orchestrator_patterns.md

rules:
  - id: orchestrator_never_implements
    priority: 0
    condition: "always"
    action: delegate_only
    description: >
      HARD RULE: The Orchestrator NEVER runs shell commands (git, npm, pip, python, etc.),
      NEVER edits or creates files, NEVER writes code. If the next step involves running
      a command, editing a file, creating a file, or any implementation — delegate it to
      the appropriate subagent (Lead Engineer, Junior Engineer 1, Junior Engineer 2, etc.).
      This includes git checkout, git fetch, git reset, git commit, git push, file creation,
      and any code changes. The Orchestrator's ONLY outputs are: (1) reading workspace/MCP,
      (2) deciding next step, (3) issuing slash-command delegations, (4) updating
      PROJECT_WORKSPACE.md Dashboard/Next Actions text (via a subagent if file edits needed).
      After a user confirms a manual action (e.g. "done", "merged", "continue"), the
      Orchestrator reads the plan, decides the next task, and delegates it to a subagent.
      It does NOT execute the next task itself.

  - id: user_checkpoint_resume
    priority: 1.5
    condition: "user_confirmed_checkpoint"
    action: read_plan_then_delegate
    target_role_from: workflow
    description: >
      After user confirms a checkpoint action (PR merged, branch created, etc.):
      (1) read PROJECT_WORKSPACE.md and git state via a subagent if needed,
      (2) decide the next concrete task from the plan,
      (3) delegate to the appropriate subagent via slash command.
      Do NOT execute the task directly. Do NOT run git commands.

  - id: pending_approvals
    priority: 1
    condition: "pending_approvals > 0"
    action: delegate_to_approver
    target_role_from: approval_request
    description: "Delegate to the role that must respond to the approval (CTO, Architect, etc.)."

  - id: user_intervention
    priority: 2
    condition: "user_intervention_required == true"
    action: stop
    target_role_from: null
    description: "Stop and report to user; do not auto-continue."

  - id: last_stage_review_merge
    priority: 3
    condition: "last_stage in [review, merge]"
    action: fetch_plan_next_steps_then_delegate_or_complete
    target_role_from: workflow
    description: "Read PROJECT_WORKSPACE.md (Implementation Plan, Next Actions, Work Log); decide next task or ORCHESTRATION_COMPLETE."

  - id: no_next_task
    priority: 4
    condition: "no next uncompleted task in plan"
    action: ORCHESTRATION_COMPLETE
    target_role_from: null
    description: "Write ORCHESTRATION_COMPLETE and stop."

  - id: default_dev_split
    priority: 5
    condition: "current_stage == dev and backlog supports tasks"
    action: split_dev_work_delegate_parallel
    target_role_from: workflow
    description: "Split dev work into three parts (part_1 → lead-engineer, part_2 → junior-engineer-1, part_3 → junior-engineer-2). Delegate all three in same response when three tasks exist; otherwise delegate only to relevant role(s)."

  - id: default_other_stages
    priority: 6
    condition: "default"
    action: delegate_by_stage
    target_role_from: workflow
    description: "Delegate according to current stage roles (workflow.yml); one or more slash commands as appropriate."
